'use strict';

var _fs = require('fs');

var _fs2 = _interopRequireDefault(_fs);

var _underscore = require('underscore');

var _underscore2 = _interopRequireDefault(_underscore);

var _gulpUtil = require('gulp-util');

var _gulpUtil2 = _interopRequireDefault(_gulpUtil);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

/**
 * Flixir is a wrapper around Gulp.
 *
 * @param {Function} recipe
 */
var Flixir = function Flixir(recipe) {
    // Perform any last-minute initializations.
    init();

    // Load all of Flixir's task definitions.
    require('require-dir')('./tasks');

    // Load the user's Gulpfile recipe.
    recipe(Flixir.mixins);

    // And run their chosen tasks.
    Flixir.tasks.forEach(function (task) {
        return task.toGulp();
    });
};

Flixir.mixins = {};
Flixir.isWatching = function () {
    return _gulpUtil2.default.env._.indexOf('watch') > -1;
};
Flixir.Log = require('./Logger').default;
Flixir.GulpPaths = require('./GulpPaths').default;
Flixir.config = require('./Config').default;
Flixir.Plugins = require('gulp-load-plugins')();
Flixir.Task = require('./Task').default(Flixir);
Flixir.tasks = new (require('./TaskCollection').default)();

Flixir.hooks = { before: [], watch: [] };
Flixir.onWatch = function (func) {
    return Flixir.hooks.watch.push(func);
};
Flixir.before = function (func) {
    return Flixir.hooks.before.push(func);
};

/**
 * Register a new task with Flixir.
 *
 * @param {string}   name
 * @param {Function} callback
 */
Flixir.extend = function (name, callback) {
    Flixir.mixins[name] = function () {
        callback.apply(this, arguments);

        return this.mixins;
    }.bind(this);
};

/**
 * Allow for config overrides, via an Flixir.json file.
 *
 * @param {string} file
 */
Flixir.setDefaultsFrom = function (file) {
    var overrides = void 0;

    if (_fs2.default.existsSync(file)) {
        overrides = JSON.parse(_fs2.default.readFileSync(file, 'utf8'));

        _underscore2.default.mixin({
            deepExtend: require('underscore-deep-extend')(_underscore2.default)
        });

        _underscore2.default.deepExtend(Flixir.config, overrides);
    }
}('Flixir.json');

/**
 * Perform any last-minute initializations.
 */
var init = function init() {
    if (!Flixir.config.notifications) {
        process.env.DISABLE_NOTIFIER = true;
    }

    Flixir.Notification = require('./Notification').default;
};

module.exports = Flixir;